---
title: "OpenFishR"
output: 
   flexdashboard::flex_dashboard:
    vertical_layout: scroll 
    theme: cosmo 
    orientation: rows
runtime: shiny
---

```{r pipo,eval=F,include=F}
#<script>
#$('.navbar-logo').wrap('<a href="https://gfcm.sharepoint.com/sites/DCRF/SitePages/Data\%20Quality.aspx">');
#</script>


library(shiny)




rmarkdown::run("OpenFishR.Rmd")#",oetput="pipo.html")
#rmarkdown::render_site("OpenFishR.Rmd")#,flex_dashboard())#",output="pipo.html")

```

```{r global, include=FALSE}
library(shiny)
library(ggplot2)
library(flexdashboard)
#library(knitr)
#library(dplyr)
#library(tidyr)
library(plotly)
#library(openxlsx)
library(DT)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(mapdata)
library(geosphere)
```

```{r data,include=F}
dataDirectory<-"./data/"
ExtraFishData <- readRDS(paste0(dataDirectory,"ExtraFishData3.RDS"))
#survey
if(F){
acous<- readRDS(paste0(dataDirectory,"AcousticSurveyCatchData.RDS"))
datras<- readRDS(paste0(dataDirectory,"DATRASCPUE.RDS"))
#presence absence
acousxy<-acous%>%transmute(time=substr(HaulStartTime,1,10),x=HaulStartLongitude,y=HaulStartLatitude,
	spp=CatchSpeciesCode,type="Acoustic",cpue=1)
datrasxy<-datras%>%transmute(time=paste(Year.x,Month,Day,sep="-"),x=ShootLong,y=ShootLat,
spp=Valid_Aphia,type="DATRAS",cpue)
surveyxy<-rbind(acousxy,datrasxy)%>%mutate(x=as.numeric(x),y=as.numeric(y))
surveyxy18<-surveyxy%>%filter(substr(time,1,4)=="2018")
saveRDS(surveyxy18,file="./data/surveyxy18.RDS")
#surveyxy18<-readRDS(file="./data/surveyxy18.RDS")
#pltdens(surveyxy18)
}

pltdens<-function(dat,sppcode="127160"){
	tmp<-dat%>%filter(spp==sppcode)
	rx<-range(tmp$x)
	ry<-range(tmp$y)
	tmp<-KernSmooth::bkde2D(tmp%>%transmute(x,y),bandwidth=c(.01,.01),gridsize=c(100,100))
	tmp<-data.frame(x=rep(tmp$x1,each=length(tmp$x1)),y=rep(tmp$x2,length(tmp$x2)),count=c(tmp$fhat))
        plt<-ggplot()+#geom_sf(data=div,fill=NA,colour="black",lwd=2)+e
                geom_raster(data=tmp,aes(x=x,y=y,fill=count),stat="identity",alpha=1)+
	#	geom_point(data=surveyxy18,aes(x=x,y=y),pch=".",alpha=.2)+
                scale_fill_distiller(palette='Spectral',name="Presence \n(Kernel density\nestimates)")+
                geom_sf(data=div,fill=NA,colour="black",lwd=.3,alpha=.5)+
                geom_sf_text(data=div,aes(label=gsub("\\.","",gsub("27.","",div))),size=3,color="black")+
                borders("world",xlim=rx,ylim=ry,fill="grey",colour=NA,alpha=1)+
                coord_sf(xlim=rx,ylim=ry)+
                theme_bw()+
                xlab("Longitude")+ylab("Latitude")
	return(plt)
}


#FDI bidouillade
if(F){
fdilan<- readRDS(paste0(dataDirectory,"fdilan.RDS"))
fdilanyear<-fdilan%>%filter(year%in%c("2014","2015","2016"))%>%
	group_by(spp,rect,x,y)%>%
                summarise(w=mean(w))%>%ungroup()
saveRDS(fdilanyear,file="./data/fdilanyear.RDS")
#country
fdilanyearcountry<-fdilan%>%filter(year%in%c("2014","2015","2016"))%>%
	group_by(spp,rect,country,x,y)%>%
                summarise(w=mean(w))%>%ungroup()
saveRDS(fdilanyearcountry,file="./data/fdilanyearcountry.RDS")
tmp<-fdilancountry%>%filter(spp=="SOL")%>%filter(!grepl("Unknown",gear))%>%
	filter(!grepl("Unknown",vesslen))%>%mutate(`Landings (t)`=w)


#fleet
fdilanfleet<-fdilan%>%filter(year%in%c("2014","2015","2016"))%>%
	group_by(spp,vesslen,gear)%>%
                summarise(w=mean(w))%>%ungroup()
saveRDS(fdilanfleet,file="./data/fdilanfleet.RDS")
tmp<-fdilanfleet%>%filter(spp=="SOL")%>%filter(!grepl("Unknown",gear))%>%
	filter(!grepl("Unknown",vesslen))%>%mutate(`Landings (t)`=w)
ggplot()+geom_point(data=tmp,aes(x=vesslen,y=gear,size=`Landings (t)`),color="blue")+
                theme_bw()+
                xlab("Vessel length")+ylab("Gear")

}


#FDI bidouillade
if(F){
fdilan<- readRDS(paste0(dataDirectory,"fdilan.RDS"))
fdilanyear<-fdilan%>%filter(year%in%c("2014","2015","2016"))%>%
	group_by(spp,rect,x,y)%>%
                summarise(w=mean(w))%>%ungroup()
saveRDS(fdilanyear,file="./data/fdilanyear.RDS")
#fleet
fdilanfleet<-fdilan%>%filter(year%in%c("2014","2015","2016"))%>%
	group_by(spp,vesslen,gear)%>%
                summarise(w=mean(w))%>%ungroup()
saveRDS(file="./data/fdilanfleet.RDS")
tmp<-fdilanfleet%>%filter(spp=="SOL")
ggplot()+geom_point(data=tmp,aes(x=vesslen,y=gear,size=w))
}
fdilanyear<- readRDS(paste0(dataDirectory,"fdilanyear.RDS"))
fdilanyearcountry<-readRDS(file="./data/fdilanyearcountry.RDS")
div<- readRDS(paste0(dataDirectory,"div.RDS"))
surveyxy18<-readRDS(file="./data/surveyxy18.RDS")
fdilanfleet<-readRDS(file="./data/fdilanfleet.RDS")
lanflux<-readRDS(file="./data/lanflux.RDS")
r2x<-range(div$x)
r2y<-range(div$y)

#stock info from ICES
if(F){
	load("../../analyses/wgparam2017.rdata")
	wgparam<-wgparam%>%filter(fao%in%ExtraFishData$fao)
}

#fleet description
if(F){
}

#SAG
SAGstock<- readRDS(paste0(dataDirectory,"SAG_stocklist.RDS"))
SAGsummary<- readRDS(paste0(dataDirectory,"SAG_summary.rds"))

```
   
```{r fct,include=F}
#wikipedia url
wikiurl<-function(sppname,dat=ExtraFishData){
 wikipediaURL <- dat[as.character(dat$CommonName)==sppname,c("WikipediaPage")]
     myURL <- paste("<a href='", as.character(wikipediaURL), "' target='_blank'>", as.character(wikipediaURL), "</a>" , sep = "")
	cat(myURL,file="myUrl.txt")
         myURL
}
#wikipedia image
wikiimg<-function(sppname,dat=ExtraFishData){
	imgurl<- dat[as.character(dat$CommonName)==sppname,c("Image")]
	paste0("<img src='",as.character(imgurl),"'>")
}
#wikipedia image
recipes<-function(sppname,dat=ExtraFishData){
	urltmp<- dat[as.character(dat$CommonName)==sppname,c("RecipeURL")]
	myURL <- paste0("<a href='", as.character(urltmp), "' target='_blank'>", "Recipes from BBC", "</a>")
}
  

#species name + scianme 
getsppname<-function(sppname,dat=ExtraFishData){
  nom1<-dat[as.character(dat$CommonName)==sppname,c("CommonName")]
  nom2<-dat[as.character(dat$CommonName)==sppname,c("SciName")]
  paste0(nom1," (",nom2,")")
}
#pecies FAO name
getfao<-function(sppname,dat=ExtraFishData){
  dat[as.character(dat$CommonName)==sppname,c("fao")]
}
#pecies AphiaIa 
getaphia<-function(sppname,dat=ExtraFishData){
  dat[as.character(dat$CommonName)==sppname,c("AphiaID")]
}

#species abstract
abstract<-function(sppname,dat=ExtraFishData){
	as.character(dat[as.character(dat$CommonName)==sppname,c("Abstract")])
}
if(F){
#abstract("common sole")
getsppname("Common sole")
getfao("Common sole")
wikiimg("Common sole")
}


rawToJpeg <- function(pic_data) {
    tF <- tempfile(fileext = ".png")
    f = file(tF, "wb")           # OPEN FILE CONNECTION
    writeBin(pic_data, con = f, useBytes=TRUE)      # TRANSFER RAW DATA
    close(f)                                        # CLOSE FILE CONNECTION
    return(tF)
}


#ScName
getSciName <- function(sppname,dat=ExtraFishData){
  as.character(dat[as.character(dat$CommonName)==sppname, c("SciName")])
}

#Loop
genStatus <- function(sppname) {
	for(i in 1:length(SAGstock[SAGstock$SpeciesName==sppname, c("StockDescription")])) {
		SAGstock[SAGstock$SpeciesName==sppname, c("StockDescription")][[i]]
		rawToJpeg(SAGstock[SAGstock$SpeciesName==sppname, c("statusPic")][[1]][[1]])
	}

	return("Hello")
}

```




Sidebar {.sidebar}
=========================================

### Select the species:

```{r}
# shiny inputs defined here
#selectInput("Species",label="Species",choice)
selectInput(c("speciesInput","pipo"), label = NULL, choices = c("None",as.character(ExtraFishData$CommonName)), selected = "Common sole")
  
```

Some text about the species selection

```{r,eval=T}
spp <- reactive((input$speciesInput))
#spp <- eventReactive(as.character(input$speciesInput))
```
 
Overview
========================================

<span style="color:black;font-size:26px;font-weight:bold"> `r renderText(getsppname(spp()))` </span>

Row
-------------------------------------
    

###

```{r,eval=T}


shinyApp(
  ui = fluidPage(
      fillCol(flex = c(NA, NA), 
      #inputPanel( textInput("speciesInput",label=NULL,value="Flet")),
      textAreaInput( "speciesInput",label=NULL,value="Flet",height='1px',width='1px'),
#	h3("Pictures"),
     
      htmlOutput("img"),
      htmlOutput("link1"),
	h3("Recipes"),
      htmlOutput("link2")
    )
  ),
  server = function(input, output,session) {
    removeUI(selector="div:has(> input)")
    #observe({ updateTextInput(session, "speciesInput", value = spp()) })
    observe({ updateTextAreaInput(session, "speciesInput", value = spp()) })
    output$img<- renderText({ paste(wikiimg(input$speciesInput))	})
    output$link1<- renderText({ paste(wikiurl(input$speciesInput))	})
    output$link2<- renderText({ paste(recipes(input$speciesInput))	})
  }
)
```

### Facts 

```{r,eval=T,}
renderText(abstract(spp()))
```

Row
-------------------------------------

### Landings (average 2014-2016) 

```{r}
  #lan year

#renderPlotly({
renderPlot({
   tmp<-fdilanyear%>%filter(spp==getfao(spp()))#%>%
   #tmp<-fdilan%>%filter(spp=="SOL"&year=="2016")%>%
	r2x<-range(tmp$x)
	r2y<-range(tmp$y)
        pltlanyear<-ggplot()+#geom_sf(data=div,fill=NA,colour="black",lwd=2)+
                geom_raster(data=tmp,aes(x=x,y=y,fill=w),stat="identity",alpha=1)+
                #geom_point(data=maplan,aes(x=x,y=y),stat="identity",alpha=1)+
                scale_fill_distiller(palette='Spectral',name="Landings (t)")+
                geom_sf(data=div,fill=NA,colour="black",lwd=.3,alpha=.5)+
                geom_sf_text(data=div,aes(label=gsub("\\.","",gsub("27.","",div))),size=3,color="black")+
                borders("world",xlim=r2x,ylim=r2y,fill="grey",colour=NA,alpha=1)+
                #facet_wrap(~country,)+
                #facet_wrap(gear~year,ncol=6,drop=FALSE)+
                coord_sf(xlim=r2x,ylim=r2y)+
                theme_bw()+
                #ggtitle(paste0("French landings for ",info$stock,"\n","in ",info$area))+
                xlab("Longitude")+ylab("Latitude")
#ggplotly(pltlanyear,tooltip=c("x","y","w"))
pltlanyear
})





```

### Distribution 

```{r}
renderPlot({
	pltdens(surveyxy18,sppcode=getaphia(spp()))#,rx=r2x,ry=r2y)
})
```

Landings flux
========================================

<span style="color:black;font-size:26px;font-weight:bold"> `r renderText(getsppname(spp()))` </span>

```{r}
renderPlot({
#	pltdens(surveyxy18,sppcode=getaphia(spp()))#,rx=r2x,ry=r2y)
lanflux<-lanflux%>%filter(spp==getfao(spp()))
lanflux<-na.omit(lanflux)
rx<-range(c(lanflux$xd,lanflux$xc),na.rm=T)
ry<-range(c(lanflux$yd,lanflux$yc),na.rm=T)
div0<-div%>%filter(div%in%unique(lanflux$div))

#test a geographical map with network of catches
#plot(NULL,xlim=rx,ylim=ry,asp=1)
plot(div0$geometry,col="light blue",add=F,xlim=rx,ylim=ry)
map('worldHires',xlim=rx,ylim=ry,fill=T,bg="light blue",col="lightgrey",lwd=0.1,add=T,wrap=T)
aa<-lanflux%>%group_by(div,xd,yd)%>%summarise(w=sum(w,na.rm=T))
points(x=lanflux$xc,y=lanflux$yc,pch=19,col="orange",cex=0.1)
points(x=aa$xd,y=aa$yd,pch=19,col="orange",cex=round(2*aa$w/max(aa$w)))
title("Landings flux between ICES divisions and countries (average 2014-2016)")
#points(x=pipo$xr,y=pipo$yr,pch=19,col="blue",cex=0.1)
#pipo1<-na.omit(pipo)
#for(i in 1:nrow(pipo1)){
col.1 <- adjustcolor("orange red", alpha=0.4)
col.2 <- adjustcolor("orange", alpha=0.4)
edge.pal <- colorRampPalette(c(col.1, col.2), alpha = TRUE)
edge.col <- edge.pal(100)
#id<-which(pipo1$rect=="29F0")
for(i in 1:nrow(lanflux)){
	                arc<-gcIntermediate(c(lanflux$xd[i],lanflux$yd[i]),c(lanflux$xc[i],lanflux$yc[i]),n=100,addStartEnd=T)
        edge.ind<-round(100*lanflux$w[i]/max(lanflux$w,na.rm=T))
	                lines(arc,col=edge.col[edge.ind],lwd=edge.ind/10)
}

})



```

Fleet
========================================

<span style="color:black;font-size:26px;font-weight:bold"> `r renderText(getsppname(spp()))` </span>

Row
-------------------------------------

###

```{r,eval=T}
renderPlotly({
tmp<-fdilanfleet%>%filter(spp==getfao(spp()))%>%filter(!grepl("Unknown",gear))%>%
	filter(!grepl("Unknown",vesslen))%>%mutate(`Landings (t)`=w)
ggplot()+geom_point(data=tmp,aes(x=vesslen,y=gear,size=`Landings (t)`))+
                theme_bw()+
		ggtitle("Fleets (2014-2106)")+
                xlab("Vessel length")+ylab("Gear")
})
```

Row
-------------------------------------

### Landings average 2014-2016 by country 


```{r,eval=T}
renderPlot({
   #tmp<-fdilanyearcountry%>%filter(spp==getfao(spp()))#%>%
   #tmp<-fdilanyearcountry%>%filter(spp=="SOL")#%>%
   tmp<-fdilanyearcountry%>%filter(spp==getfao(spp()))#%>%
   #tmp<-fdilan%>%filter(spp=="SOL"&year=="2016")%>%
	r2x<-range(tmp$x)
	r2y<-range(tmp$y)
        pltcountry<-ggplot()+#geom_sf(data=div,fill=NA,colour="black",lwd=2)+
                geom_raster(data=tmp,aes(x=x,y=y,fill=w),stat="identity",alpha=1)+
                #geom_point(data=maplan,aes(x=x,y=y),stat="identity",alpha=1)+
                scale_fill_distiller(palette='Spectral',name="Landings (t)")+
                #geom_sf(data=div,fill=NA,colour="black",lwd=.3,alpha=.5)+
                #geom_sf_text(data=div,aes(label=gsub("\\.","",gsub("27.","",div))),size=3,color="black")+
                borders("world",xlim=r2x,ylim=r2y,fill="grey",colour=NA,alpha=1)+
                facet_wrap(~country,ncol=5)+
                #facet_wrap(gear~year,ncol=6,drop=FALSE)+
                coord_sf(xlim=r2x,ylim=r2y)+
                theme_bw()+
                #ggtitle(paste0("French landings for ",info$stock,"\n","in ",info$area))+
                xlab("Longitude")+ylab("Latitude")
#ggplotly(pltlanyear,tooltip=c("x","y","w"))
pltcountry

})
```

Stock status 
=======================================================

<span style="color:black;font-size:26px;font-weight:bold"> `r renderText(getsppname(spp()))` </span>

Row
-------------------------------------

### Status 

```{r}
#renderText({reactive({
#genStatus(getSciName(spp()))
#})
#})

renderImage({list(src=rawToJpeg(SAGstock[SAGstock$SpeciesName==getSciName(spp()), c("statusPic")][[1]][[1]]))})
```


Row
-------------------------------------

### Summaries 

```{r}
renderImage({list(src=rawToJpeg(SAGstock[SAGstock$SpeciesName==getSciName(spp()), c("statusPic")][[1]][[2]]))})
```



About
========================================
OSL and data sources
